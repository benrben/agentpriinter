# Refactor: Break up “big files” in the React runtime (no behavior changes)

## 1. The Contract
**Primary module(s)**:
- `agentprinter-react/src/renderer.tsx` (currently ~1957 LOC; main hotspot)
- Secondary “large-ish” modules (200–350 LOC):  
  `agentprinter-react/src/provider.tsx`, `agentprinter-react/src/contracts.ts` (generated),  
  `agentprinter-react/src/components/navigation.tsx`, `overlay.tsx`, `datetime.tsx`, `content.tsx`, `file.tsx`, `data.tsx`

**Explicitly out-of-scope (do not refactor by hand)**:
- `agentprinter-react/src/types.ts` — generated (“DO NOT MODIFY IT BY HAND”)
- `agentprinter-react/src/contracts.ts` — generated (“Generated by ts-to-zod”)

**Public API (must remain identical)**:
- `agentprinter-react/index.ts` exports and semantics remain unchanged:  
  `AgentPrinterRuntime`, `AgentPrinterProvider`, `useAgentPrinter`, `RemoteComponent`, and `export * from "./src/contracts"; export * from "./src/types";`

**Behavioral invariants (must maintain)**:
- **Renderer invariants** (Remote UI Runtime contract):
  - Unknown component types render a placeholder (do not crash).  
    **Scope**: `Scopes/Product/Frontend/Remote_UI_Runtime.md`
  - Inline styles are filtered by an allowlist and unsafe properties/values are stripped with warnings.
  - `registerComponent(name, component, options?)` overrides built-ins and stores optional meta (propsSchema/eventSchema).
  - If a component has `propsSchema`, invalid props warn + render fallback placeholder.
  - Bindings read from optional state provider and map state paths into props.
  - Recursive rendering preserves `key` selection (`child.key || child.id`).
- **Provider invariants**:
  - Incoming messages must pass `messageSchema` envelope validation; invalid JSON or invalid envelopes are logged and ignored.
  - Typed payload validation is enforced for `protocol.error` (invalid payload is warned and dropped).
  - Reconnect uses exponential backoff and sends `protocol.resume` on reconnect using `payload.last_seen_seq`.
  - `sendMessage` only sends when socket is OPEN; otherwise warns.
  - Message history remains bounded (last ~100).
- **Runtime invariants**:
  - `ui.render` validates root with `componentNodeSchema` before setting.
  - `ui.patch` applies operations and ignores stale updates using monotonic ordering on `header.seq` (when present).
  - `protocol.navigate` uses adapter if provided, else `window.history`.

**Evidence (tests + scopes that must stay green)**:
- Contract scopes:
  - `Scopes/Product/Frontend/Remote_UI_Runtime.md`
  - `Scopes/Product/Contracts/Protocol_Schema.md`
  - `Scopes/GRAPH.md` (evidence links will need updating after moves)
- Key tests (non-exhaustive; keep suite green each phase):
  - `agentprinter-react/tests/renderer.test.tsx`
  - `agentprinter-react/tests/component-registry.test.tsx`
  - `agentprinter-react/tests/style-validation.test.tsx`
  - `agentprinter-react/tests/interactive.test.tsx`
  - `agentprinter-react/tests/provider.test.tsx`
  - `agentprinter-react/tests/runtime.test.tsx`
  - `agentprinter-react/tests/transport-backoff.test.tsx`

**Scopes that will require evidence-link maintenance (line numbers will change)**:
- `Scopes/Product/Frontend/Remote_UI_Runtime.md`
- `Scopes/Product/Contracts/Protocol_Schema.md`
- `Scopes/GRAPH.md`
- Additional non-Product docs that currently cite moved line ranges (update as needed):
  - `Scopes/Work/Bugs/2026-02-01-general-scan-seq-resume-and-transport-footguns.md`
  - `Scopes/Work/Tasks/2026-02-01-react-readme-and-provider-api.md`
  - `Scopes/Work/Tasks/2026-02-01-frontend-use-seq-for-ordering-and-resume.md`
  - `Scopes/Work/Tasks/*` referencing `renderer.tsx` / component bank

## 2. Strategy: Extract Modules + Re-export “Facade Files”
This uses **Extract Module** with a stable public “facade” file to keep imports/exports identical while reducing file size.

- **Why this pattern**: it’s the lowest-risk way to split files while preserving external behavior; each step is mostly moving code, not rewriting it.
- **Key safety technique**: `src/renderer.tsx` / `src/provider.tsx` remain the public entrypoints (or become thin re-exports) so downstream imports don’t change.

## 3. Execution Phases

### Phase 0: Lockdown (Safety)
- [ ] Run `cd agentprinter-react && bun test` to establish a green baseline.
- [ ] Confirm the “big file” targets by line count (renderer is the outlier; `types.ts`/`contracts.ts` are generated and excluded).
- [ ] If any renderer sub-behavior is not covered by tests, add **minimal characterization tests** (no new features), e.g.:
  - registry override precedence (`registerComponent` replaces built-in)
  - style filter allowlist + blocked patterns
  - unknown component placeholder + invalid props placeholder
- [ ] **Verification gate**: tests pass.

### Phase 1: Create seams (no moves yet)
- [ ] Create internal folders (no behavior changes):
  - `agentprinter-react/src/renderer/`
  - `agentprinter-react/src/provider/`
- [ ] Add “barrel” exports inside these folders (e.g. `renderer/index.ts`, `provider/index.ts`) but keep `src/renderer.tsx` and `src/provider.tsx` as the public surfaces.
- [ ] **Verification gate**: tests pass.
- [ ] **Scope maintenance (prep)**: add a checklist of the specific evidence links that will need updating once the move happens (do not update prematurely).

### Phase 2: Split `renderer.tsx` — style filtering (pure extraction)
- [ ] Move the style allowlist constants + `filterStyles()` into `agentprinter-react/src/renderer/styleFilter.ts`.
- [ ] Keep the exact warning strings and filtering semantics.
- [ ] `RemoteComponent` continues to call `filterStyles` exactly as before.
- [ ] **Verification gate**: tests pass.
- [ ] **Scope update**: update any scope evidence links that referenced the old style-filter line range to the new file/lines (primarily `Remote_UI_Runtime.md`).

### Phase 3: Split `renderer.tsx` — registry + registration API
- [ ] Extract registry state into `agentprinter-react/src/renderer/registry.ts`:
  - `REGISTRY`, `REGISTRY_META`
  - `registerComponent()`
  - `getComponentRegistry()`
  - `ComponentRegistrationOptions`
- [ ] Extract the built-in mapping (the large `REGISTRY = { ... }`) into `agentprinter-react/src/renderer/builtins.ts` (or `renderer/builtins/index.ts`) and initialize the registry from it.
- [ ] Preserve override semantics (custom registration must win).
- [ ] **Verification gate**: tests pass.
- [ ] **Scope maintenance**:
  - Update evidence links in `Scopes/GRAPH.md` and `Remote_UI_Runtime.md` that point to `registerComponent` / registry sections.

### Phase 4: Split `renderer.tsx` — `RemoteComponent` renderer
- [ ] Move `RemoteComponent` into `agentprinter-react/src/renderer/RemoteComponent.tsx`.
- [ ] Keep `agentprinter-react/src/renderer.tsx` exporting `RemoteComponent` (re-export from the new module) so `index.ts` stays unchanged.
- [ ] Preserve:
  - unknown component placeholder markup + `data-testid`
  - invalid props placeholder markup + `data-testid`
  - bindings logic and state optionality (`tryUseContext`)
  - recursive children rendering key choice
- [ ] **Verification gate**: tests pass.
- [ ] **Scope maintenance**: update all relevant evidence links (Remote UI Runtime scope + GRAPH evidence table).

### Phase 5: Split “large-ish” component family files (only if they’re still pain points)
These files are already “family grouped” and not dangerously large; prioritize only if they’re actively blocking work.

- [ ] For each target family file (e.g. `components/navigation.tsx`, `overlay.tsx`, `datetime.tsx`, etc.), split into:
  - `agentprinter-react/src/components/<family>/...` (one file per exported component)
  - keep `agentprinter-react/src/components/<family>.tsx` as a re-export facade to preserve imports from `renderer.tsx` (and any user code).
- [ ] **Verification gate** after each family: tests pass.
- [ ] **Scope maintenance**: update evidence links in `Remote_UI_Runtime.md` if any were pointing at these files/lines.

### Phase 6: Documentation + graph synchronization (mandatory)
- [ ] Update Product scopes **only to reflect moved code** (no behavior changes):
  - `Scopes/Product/Frontend/Remote_UI_Runtime.md` evidence links + trace line numbers
  - `Scopes/Product/Contracts/Protocol_Schema.md` evidence links (if any referenced moved frontend validation code)
- [ ] Update `Scopes/GRAPH.md` evidence links for any moved code (especially references that currently cite `agentprinter-react/src/renderer.tsx` line ranges).
- [ ] Ensure “exactly 2 diagrams remain” in each substantial Product scope touched.
- [ ] **Verification gate**: tests pass; links resolve.

## Audit Checklist
- [ ] Every phase ends green (`bun test`)
- [ ] No behavior changes (only moves/extracts/re-exports)
- [ ] Generated files (`src/types.ts`, `src/contracts.ts`) are not manually edited
- [ ] All impacted `Scopes/Product/**` evidence links updated after moves
- [ ] `Scopes/GRAPH.md` evidence table updated for new file/line locations

